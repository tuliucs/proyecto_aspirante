@startuml
hide circle
skinparam linetype ortho

entity "catalogo" as catalogo {
  *id_catalogo : BIGINT <<PK>>
  --
  codigo : VARCHAR
  nombre : VARCHAR
  descripcion : VARCHAR
  activo : TINYINT
}

entity "catalogo_detalle" as catdet {
  *id_catalogo_detalle : BIGINT <<PK>>
  --
  catalogo_id : BIGINT <<FK>>
  codigo : VARCHAR
  nombre : VARCHAR
  orden : INT
  activo : TINYINT
}

entity "dependencia" as dependencia {
  *id_dependencia : BIGINT <<PK>>
  --
  nombre : VARCHAR
  tipo : VARCHAR
  region : VARCHAR
  departamento : VARCHAR
  municipio : VARCHAR
  direccion : VARCHAR
  telefono : VARCHAR
  activo : TINYINT
}

entity "rol" as rol {
  *id_rol : BIGINT <<PK>>
  --
  nombre : VARCHAR
}

entity "permiso" as permiso {
  *id_permiso : BIGINT <<PK>>
  --
  codigo : VARCHAR
}

entity "rol_permiso" as rol_permiso {
  *rol_id : BIGINT <<FK>>
  *permiso_id : BIGINT <<FK>>
}

entity "usuario" as usuario {
  *id_usuario : BIGINT <<PK>>
  --
  dependencia_id : BIGINT <<FK>>
  rol_id : BIGINT <<FK>>
  nombres : VARCHAR
  apellidos : VARCHAR
  username : VARCHAR
  email : VARCHAR
  estado : VARCHAR
}

entity "caso" as caso {
  *id_caso : BIGINT <<PK>>
  --
  fiscalia_id : BIGINT <<FK>>
  fiscal_asignado_id : BIGINT <<FK>>
  numero_expediente : VARCHAR
  tipo_delito_id : BIGINT <<FK>>  -- catalogo_detalle
  estado_id : BIGINT <<FK>>       -- catalogo_detalle
}

entity "escena" as escena {
  *id_escena : BIGINT <<PK>>
  --
  caso_id : BIGINT <<FK>>
  tipo_escena_id : BIGINT <<FK>>  -- catalogo_detalle
}

entity "escena_equipo" as escena_equipo {
  *escena_id : BIGINT <<FK>>
  *usuario_id : BIGINT <<FK>>
}

entity "indicio" as indicio {
  *id_indicio : BIGINT <<PK>>
  --
  caso_id : BIGINT <<FK>>
  escena_id : BIGINT <<FK>>
  codigo_indicio : VARCHAR
  tipo_indicio_id : BIGINT <<FK>>        -- catalogo_detalle
  metodo_recoleccion_id : BIGINT <<FK>>  -- catalogo_detalle
  embalaje_tipo_id : BIGINT <<FK>>       -- catalogo_detalle
  estado_id : BIGINT <<FK>>              -- catalogo_detalle
  recolectado_por_id : BIGINT <<FK>>
}

entity "cadena_custodia" as cadena {
  *id_cadena : BIGINT <<PK>>
  --
  indicio_id : BIGINT <<FK>> <<UNIQUE>>
  responsable_inicial_id : BIGINT <<FK>>
}

entity "ubicacion" as ubicacion {
  *id_ubicacion : BIGINT <<PK>>
  --
  dependencia_id : BIGINT <<FK>>
  tipo : VARCHAR
  nombre : VARCHAR
}

entity "movimiento_custodia" as mov {
  *id_movimiento : BIGINT <<PK>>
  --
  cadena_id : BIGINT <<FK>>
  tipo_movimiento_id : BIGINT <<FK>> -- catalogo_detalle
  de_usuario_id : BIGINT <<FK>>
  a_usuario_id : BIGINT <<FK>>
  de_dependencia_id : BIGINT <<FK>>
  a_dependencia_id : BIGINT <<FK>>
  origen_ubicacion_id : BIGINT <<FK>>
  destino_ubicacion_id : BIGINT <<FK>>
}

entity "ingreso_bodega" as ingreso {
  *id_ingreso : BIGINT <<PK>>
  --
  indicio_id : BIGINT <<FK>>
  ubicacion_id : BIGINT <<FK>>
  responsable_recibe_id : BIGINT <<FK>>
}

entity "solicitud_peritaje" as solicitud {
  *id_solicitud : BIGINT <<PK>>
  --
  caso_id : BIGINT <<FK>>
  tipo_solicitud_id : BIGINT <<FK>> -- catalogo_detalle
  prioridad_id : BIGINT <<FK>>      -- catalogo_detalle
  estado_id : BIGINT <<FK>>         -- catalogo_detalle
  solicitante_usuario_id : BIGINT <<FK>>
  solicitante_dependencia_id : BIGINT <<FK>>
}

entity "asignacion_trabajo" as asignacion {
  *id_asignacion : BIGINT <<PK>>
  --
  solicitud_id : BIGINT <<FK>>
  responsable_id : BIGINT <<FK>>
  estado_id : BIGINT <<FK>>         -- catalogo_detalle
}

entity "analisis" as analisis {
  *id_analisis : BIGINT <<PK>>
  --
  indicio_id : BIGINT <<FK>>
  tipo_analisis_id : BIGINT <<FK>>  -- catalogo_detalle
  estado_id : BIGINT <<FK>>         -- catalogo_detalle
  perito_id : BIGINT <<FK>>
  laboratorio_id : BIGINT <<FK>>
}

entity "informe_pericial" as informe {
  *id_informe : BIGINT <<PK>>
  --
  caso_id : BIGINT <<FK>>
  solicitud_id : BIGINT <<FK>>
  estado_id : BIGINT <<FK>>         -- catalogo_detalle
  emitido_por_id : BIGINT <<FK>>
  aprobado_por_id : BIGINT <<FK>>
}

entity "informe_analisis" as informe_analisis {
  *informe_id : BIGINT <<FK>>
  *analisis_id : BIGINT <<FK>>
}

entity "archivo_digital" as archivo {
  *id_archivo : BIGINT <<PK>>
  --
  indicio_id : BIGINT <<FK>>
  analisis_id : BIGINT <<FK>>
  cargado_por_id : BIGINT <<FK>>
  hash_sha256 : CHAR(64)
}

entity "bitacora_auditoria" as audit {
  *id_evento : BIGINT <<PK>>
  --
  usuario_id : BIGINT <<FK>>
  accion : VARCHAR
  entidad : VARCHAR
  registro_id : BIGINT
  detalle : JSON
}

catalogo ||--{ catdet

dependencia ||--{ usuario
rol ||--{ usuario
rol ||--{ rol_permiso
permiso ||--{ rol_permiso

dependencia ||--{ caso
usuario ||--{ caso : fiscal_asignado

caso ||--{ escena
escena ||--{ escena_equipo
usuario ||--{ escena_equipo

caso ||--{ indicio
escena ||--{ indicio
usuario ||--{ indicio : recolectado_por

indicio ||--|| cadena
cadena ||--{ mov
dependencia ||--{ ubicacion
ubicacion ||--{ ingreso
indicio ||--{ ingreso

caso ||--{ solicitud
solicitud ||--{ asignacion
usuario ||--{ asignacion

indicio ||--{ analisis
usuario ||--{ analisis : perito
ubicacion ||--{ analisis : laboratorio

caso ||--{ informe
solicitud ||--{ informe
informe ||--{ informe_analisis
analisis ||--{ informe_analisis

indicio ||--{ archivo
analisis ||--{ archivo
usuario ||--{ archivo

usuario ||--{ audit

' Relaciones a catalogo_detalle (conceptual)
catdet ||--{ caso
catdet ||--{ escena
catdet ||--{ indicio
catdet ||--{ mov
catdet ||--{ solicitud
catdet ||--{ asignacion
catdet ||--{ analisis
catdet ||--{ informe
@enduml
